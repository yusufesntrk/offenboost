# Orchestrator + FEATURES.md Auto-Update Integration Guide

This document describes how to integrate automatic FEATURES.md updates into the orchestrator pipeline.

## Current State

The orchestrator currently follows this flow:

```
User: /orchestrate "Feature Name"
  â†“
Orchestrator Start
  â”œâ”€ Backend Agent â†’ Completes
  â”œâ”€ Frontend Agent â†’ Completes
  â”œâ”€ UI Review Agent â†’ Completes (parallel with Frontend)
  â”œâ”€ Test Agent â†’ Completes
  â†“
Orchestrator Report
  â””â”€ Summary of what was built
  â””â”€ Links to created files
  â””â”€ Test results
```

## Proposed: Auto-Update Integration

Add a new final stage to the orchestrator:

```
User: /orchestrate "Feature Name"
  â†“
Orchestrator Start
  â”œâ”€ Backend Agent â†’ Completes
  â”œâ”€ Frontend Agent â†’ Completes
  â”œâ”€ UI Review Agent â†’ Completes (parallel with Frontend)
  â”œâ”€ Test Agent â†’ Completes
  â”œâ”€ [âœ¨ NEW âœ¨] Auto-Update FEATURES.md Stage
  â”‚  â”œâ”€ Parse orchestrator output
  â”‚  â”œâ”€ Extract implementation summary
  â”‚  â”œâ”€ Determine phase/category
  â”‚  â”œâ”€ Update FEATURES.md
  â”‚  â”œâ”€ Create git commit
  â”‚  â””â”€ Report changes
  â†“
Orchestrator Report
  â”œâ”€ Summary of what was built
  â”œâ”€ Links to created files
  â”œâ”€ Test results
  â””â”€ âœ… FEATURES.md updated automatically
```

## Implementation Steps

### 1. Create Output Parser

Add to orchestrator reporting pipeline:

```typescript
// Extract summary from orchestrator output
const summary = {
  backend: {
    migrations: [...files created],
    hooks: [...hooks created],
    utilities: [...utility files],
  },
  frontend: {
    components: [...components created],
    pages: [...pages modified],
    integrations: [...where integrated],
  },
  tests: {
    count: number_of_tests,
    scenarios: [...test descriptions],
    fixtures: [...fixture files],
  }
}
```

### 2. Classify into Phase

```typescript
const phase = classifyFeature(summary, featureName);
// Returns: { phase: "2.5", section: "2.5", category: "Document Management System" }

// Based on:
// - Feature name keywords
// - Which tables created
// - Component types created
// - Integration points
```

### 3. Generate FEATURES.md Updates

Using FEATURES_UPDATE_PROMPT.md as template:

```typescript
const updates = generateFeaturesUpdates({
  phase: phase.phase,
  featureName: featureName,
  summary: summary,
  existingContent: readFEATURES()
});

// Returns structured changes:
// - Lines to modify
// - New sections to add
// - Items to remove
// - Section renumbering
```

### 4. Apply Changes

```typescript
// Apply updates to FEATURES.md in order:
// 1. Update existing checklist items to [x]
// 2. Add new subsection (if needed)
// 3. Update phase status table
// 4. Update "NÃ¤chste Schritte" priorities
// 5. Remove from Phase 6 if applicable
// 6. Verify formatting
```

### 5. Git Commit

```bash
git add FEATURES.md
git commit -m "docs: Update FEATURES.md - [Feature] Phase X.Y âœ…

- Added/Updated subsection X.Y
- Marked all items as complete
- Updated status table
- Removed from priority list

ğŸ¤– Auto-generated by Orchestrator"
```

### 6. Report Results

Show user:
```
âœ… FEATURES.md Updated Successfully

Changes:
- Added: Phase 2.5 - Document Management System (47 lines)
- Modified: 3 items marked complete
- Updated: Status table (Phase 2)
- Updated: NÃ¤chste Schritte (removed item #2)
- Removed: Phase 6.2 Document Management

Git: âœ… Committed as [commit-hash]
```

## Integration Points

### Option A: CLI Hook (Recommended for MVP)

Add to `.claude/orchestrator/post-completion.ts`:

```typescript
import { updateFeaturesAutomatically } from './features-updater';

export async function postOrchestrationCompletion(
  featureName: string,
  orchestratorOutput: OrchestrationResult
) {
  console.log('ğŸ”„ Updating FEATURES.md...');

  try {
    const result = await updateFeaturesAutomatically(
      featureName,
      orchestratorOutput
    );

    console.log('âœ… FEATURES.md updated successfully');
    console.log(result.summary);

  } catch (error) {
    console.warn('âš ï¸ Failed to auto-update FEATURES.md:', error.message);
    console.log('ğŸ“ You can manually run: /update-features "' + featureName + '"');
  }
}
```

### Option B: Slash Command Integration

Modify orchestrator to suggest auto-update after completion:

```
âœ… Orchestration Complete!

[Summary of created files...]

ğŸ’¡ Auto-Update FEATURES.md?
   Run: /update-features "Document Management System"
   Or press 'Y' to run now...
```

Then user presses Y to trigger:
```
/update-features "Document Management System" --auto-commit
```

### Option C: Full Integration (Future)

Integrate directly into orchestrator agent:

```typescript
// In orchestrator's final reporting stage
class OrchestrationReporter {
  async report(output: OrchestrationResult) {
    // Existing reporting...

    // NEW: Auto-update FEATURES.md
    const featureName = this.extractFeatureName(output);
    await this.autoUpdateFeatures(featureName, output);

    // Show final report
    this.showFinalReport(output);
  }
}
```

## File References

### Core Files to Modify

1. **`.claude/orchestrator/index.ts`** or main orchestrator file
   - Add post-completion hook
   - Call FEATURES.md updater after test agent completes

2. **`.claude/orchestrator/features-updater.ts`** (NEW)
   - Implement updateFeaturesAutomatically() function
   - Uses FEATURES_UPDATE_PROMPT.md as reference
   - Handles all update logic

3. **`.claude/commands/update-features.md`**
   - Manual fallback if auto-update fails
   - Can be run standalone anytime

4. **`.claude/orchestrator/FEATURES_UPDATE_PROMPT.md`**
   - Template/reference for update logic
   - Used by features-updater.ts as guide

## Testing the Integration

### Manual Test

1. Run orchestration:
   ```bash
   /orchestrate "Test Feature"
   ```

2. Check if FEATURES.md was updated:
   ```bash
   git status  # Should show FEATURES.md modified
   git diff FEATURES.md  # Should show expected changes
   ```

3. Verify commit:
   ```bash
   git log --oneline -1  # Should show auto-update commit
   ```

### Rollback If Needed

```bash
git revert HEAD  # Revert auto-update if something went wrong
# Then run: /update-features "Feature Name" --manual
```

## Configuration Options

Add to `.env` or config file:

```env
# Auto-update FEATURES.md after orchestration
AUTO_UPDATE_FEATURES=true

# Auto-commit changes (requires clean git state)
AUTO_COMMIT_FEATURES=true

# Verbose logging
FEATURES_UPDATE_VERBOSE=true
```

## Fallback Handling

If auto-update fails:

```typescript
catch (error) {
  // Log error but don't block orchestration
  console.warn('âš ï¸ Failed to auto-update FEATURES.md');
  console.log('ğŸ“ Manual update needed. Run:');
  console.log(`   /update-features "${featureName}"`);

  // Return warning in orchestration report
  return {
    status: 'COMPLETE_WITH_WARNING',
    warning: 'FEATURES.md needs manual update',
    command: `/update-features "${featureName}"`
  }
}
```

## Future Enhancements

1. **Smart Phase Detection** - Automatically determine phase from codebase changes
2. **Changelog Auto-Generation** - Create CHANGELOG.md entries for each feature
3. **Status Board Integration** - Update external project management tools
4. **Notification System** - Notify team when feature is documented
5. **History Tracking** - Keep audit trail of what was built when

## References

- FEATURES_UPDATE_PROMPT.md - Detailed update procedure
- .claude/commands/update-features.md - Manual command
- Current FEATURES.md structure - What we're updating

## Approval Checklist

Before implementing integration, verify:

- [ ] FEATURES_UPDATE_PROMPT.md is complete and clear
- [ ] Post-orchestration hook point identified
- [ ] features-updater.ts logic designed
- [ ] Git commit message format approved
- [ ] Error handling strategy defined
- [ ] Fallback mechanism in place
- [ ] Testing procedure documented
- [ ] User is aware of auto-commit behavior

---

## Quick Start for Implementation

If you want to implement this:

1. **Start with Option B** (Slash command suggestion)
   - Easier to test and iterate
   - Doesn't require modifying core orchestrator
   - User has explicit control

2. **Then move to Option A** (Post-completion hook)
   - Create `.claude/orchestrator/features-updater.ts`
   - Add hook to orchestrator's main file
   - Test thoroughly before enabling by default

3. **Eventually reach Option C** (Full integration)
   - Fully automatic, seamless experience
   - Requires robust error handling
   - Consider for v2.0 of orchestrator

---
